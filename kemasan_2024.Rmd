---
title: "Laporan Hasil Pengawasan Kemasan Tahun 2021-2023"
author: "Zaky Nur Kusmantoro"
date: '2024-01-20'
output:
  html_document: default
---

```{r setup, include=FALSE}
library(readxl)
library(tidyverse)
library(ggforce)
library(shiny)
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning=FALSE}
kemasan <- read_xlsx("kemasanpc_24.xlsx",sheet = "EDITSPO_Rekap KP PC TA 2022 (LE", range = "A6:AE759")
tbl1 <- kemasan %>% select(semester, lokasi_sampling, migrasi1, cemaran)
#glimpse(tbl1)
```

## Perhitungan Migrasi
::: {style="text-align: justify;"}
Pertama, akan dilihat dulu jumlah data **migrasi** berdasarkan waktunya (Semester 2 Tahun 2021 - Semester 1 Tahun 2023) dan dikelompokkan berdasarkan batasnya yaitu 1 untuk `(x < 0,5)`, 2 untuk `(0,05 ≤ x< 0,6)`, dan 3 untuk `(x ≥ 0,6)`
:::

```{r, warning=FALSE, cache=FALSE}
tbl1 <- tbl1 %>% mutate(batas_migrasi = ifelse(migrasi1<0.05,1,ifelse(migrasi1>=0.05&migrasi1<0.6,2,3)),
                batas_cemaran = ifelse(cemaran<0.01,1,2))
#menghilangkan nilai NA (missing value)
tbl1 <- tbl1 %>% drop_na(migrasi1)

#Jumlah untuk tiap semester dan batas migrasi
migrasi_tbl1 <- tbl1 %>% group_by(semester, batas_migrasi) %>% summarise(n_migrasi = n(), .groups = "keep")

#Jumlah untuk tiap semester
n_semester <- tbl1 %>% group_by(semester) %>% summarise(N = n())

#Gabungan untuk total semester
tbl_temp <- migrasi_tbl1 %>% left_join(n_semester, by = "semester") %>% mutate(persen = round(100*n_migrasi/N,2))
```

::: {style="text-align: justify;"}
**Tabel Perhitungan Jumlah untuk Setiap Batas dalam Semester**
:::

```{r, warning=FALSE, cache=FALSE}
#tabel perhitungan
tbl1_output <- tbl_temp %>% select(semester, N, batas_migrasi, n_migrasi) %>% pivot_wider(names_from = "batas_migrasi", values_from = "n_migrasi")
#tbl1_output$semester <- factor(tbl1_output$semester, levels = c("2021-02","2022-01","2022-02","2023-01"))
colnames(tbl1_output)[3:5] <- c("x < 0,5","0,05 ≤ x< 0,6","x ≥ 0,6")
reactable::reactable(tbl1_output, filterable = TRUE)
```

::: {style="text-align: justify;"}
**Tabel Perhitungan Persentase untuk Setiap Batas dalam Semester**
:::

```{r warning=FALSE, cache=FALSE}
#tabel persentase
tbl1_output_persen <- tbl_temp %>% select(semester, N, batas_migrasi, persen) %>% pivot_wider(names_from = "batas_migrasi", values_from = "persen") %>% arrange(semester)
colnames(tbl1_output_persen)[3:5] <- c("x < 0,5","0,05 ≤ x< 0,6","x ≥ 0,6")
reactable::reactable(tbl1_output_persen, filterable = TRUE)
```

::: {style="text-align: justify;"}
Selanjutnya, pembagian terhadap **Sarana Produksi** dan **Sarana Distribusi** untuk setiap semester
:::

```{r warning=FALSE, cache=FALSE}
#Jumlah untuk tiap semester dan batas migrasi per sarana
migrasi_tbl2 <- tbl1 %>% group_by(semester, lokasi_sampling, batas_migrasi) %>% summarise(n_migrasi = n(), .groups = "keep")

#Jumlah untuk tiap semester
n_semester2 <- tbl1 %>% group_by(semester, lokasi_sampling,) %>% summarise(N = n(), .groups = "keep")

#Gabungan untuk total semester
tbl_temp2 <- migrasi_tbl2 %>% left_join(n_semester2, by = c("semester","lokasi_sampling")) %>% mutate(persen = round(100*n_migrasi/N,2))
```

::: {style="text-align: justify;"}
**Tabel Perhitungan Jumlah untuk Setiap Batas dan Lokasi Sampling dalam Semester**
:::

```{r warning=FALSE, cache=FALSE}
#tabel perhitungan
tbl1_output2 <- tbl_temp2 %>% select(semester, lokasi_sampling, batas_migrasi, N, n_migrasi) %>% pivot_wider(names_from = "batas_migrasi", values_from = "n_migrasi")
colnames(tbl1_output2)[4:6] <- c("x < 0,5","0,05 ≤ x< 0,6","x ≥ 0,6")
reactable::reactable(tbl1_output2, filterable = TRUE)
```

::: {style="text-align: justify;"}
**Tabel Persentase Jumlah untuk Setiap Batas dan Lokasi Sampling dalam Semester**
:::

```{r warning=FALSE, cache=FALSE}
tbl1_output3 <- tbl_temp2 %>% select(semester, lokasi_sampling, batas_migrasi, N, persen) %>% pivot_wider(names_from = "batas_migrasi", values_from = "persen")
colnames(tbl1_output3)[4:6] <- c("x < 0,5","0,05 ≤ x< 0,6","x ≥ 0,6")
reactable::reactable(tbl1_output3, filterable = TRUE)
```

::: {style="text-align: justify;"}
**Persebaran Nilai Migrasi untuk setiap Semester dan Lokasi Sampling**
:::

```{r fig.width = 12, fig.height = 7, fig.fullwidth = TRUE, warning=FALSE, message=FALSE, cache=FALSE, out.width='100%'}
tbl1$batas_migrasi <- factor(tbl1$batas_migrasi, levels = 1:3, labels = c("x < 0,5","0,05 ≤ x< 0,6","x ≥ 0,6"))
ggplot(tbl1, aes(lokasi_sampling, migrasi1)) +
  geom_boxplot(outlier.shape = NA)+
  geom_sina(aes(colour = batas_migrasi, group = lokasi_sampling), size = 2)+
  facet_wrap(~semester, nrow = 1) +
  geom_hline(yintercept = 0.6, size = 1, linetype = "dashed", color = "red") +
  geom_hline(yintercept = 0.05, size = 1, linetype = "dashed", color = "red") +
  scale_colour_manual(values = c("#a1dab4","#41b6c4","#225ea8")) +
  theme_bw()
```

::: {style="text-align: justify;"}
Grafik `boxplot` berfungsi untuk memetakan distribusi data, kemudian digambarkan plot untuk setiap data untuk melihat ada berapa titik yang lebih dari batas `x ≥ 0,6` dan diantara 0,05 dan 0,6 `0,05 ≤ x< 0,6`. Garis merah tersebut menandakan batas-batas dari yang ditentukan yaitu 0,6 (yang di bagian atas) dan 0,05 (yang di bagian bawah).
:::

::: {style="text-align: justify;"}
**Peta Persebaran Migrasi dari Lokasi Sampling Semester 2 2021 hingga Semester 1 2023** Selanjutnya, akan dilihat persebaran titik berdasarkan lokasinya dengan ditandai lokasi yang memiliki nilai migrasi ≥ 0,6
:::

```{r fig.width = 12, fig.height = 5, fig.fullwidth = TRUE, echo=TRUE, out.width='100%', warning=FALSE, cache=FALSE}
library(sf)
library(ggplot2)

# Untuk mengambil peta Indonesia
indo <- read_xlsx("maps_indo.xlsx") #Peta indonesia
#colnames(kemasan)
spasial <- kemasan %>% select(semester, lokasi_sampling, balai, kab_kota, long, lat, migrasi1) %>% 
  mutate(batas_migrasi = ifelse(migrasi1<0.05,1,ifelse(migrasi1>=0.05&migrasi1<0.6,2,3))) %>%
  arrange(migrasi1)
spasial$batas_migrasi <- factor(spasial$batas_migrasi, levels = 1:3, labels = c("x < 0,5","0,05 ≤ x< 0,6","x ≥ 0,6"))

#menentukan batas untuk memunculkan yang > 0,6
idx_1 <- which(spasial$migrasi1 >= 0.6)

  ggplot(data = spasial %>% drop_na(migrasi1), aes(long, lat)) +
  geom_map(data = indo, map = indo, aes(x = long, y = lat, map_id = region),fill = "grey75") +
  geom_point(data = spasial %>% drop_na(`migrasi1`), aes(size = migrasi1, color = batas_migrasi)) +
  guides(color = guide_legend(title = "Batas Migrasi"), size = guide_legend(title = "Nilai Migrasi")) +
  geom_text(data = spasial[idx_1,], aes(long, lat), label = spasial$balai[idx_1], nudge_y = -0.5, check_overlap = TRUE, size = 2.5) +
  scale_color_manual(values = c('#fcbba1','#fb6a4a','#a50f15')) +
  theme_minimal()
```

```{r warning=FALSE, cache=FALSE}
reactable::reactable(spasial[idx_1,] %>% select(semester, lokasi_sampling, balai, migrasi1), filterable = TRUE)
```

## Perhitungan Kadar Cemaran
::: {style="text-align: justify;"}
Selanjutnya, akan dilihat dulu jumlah data **cemaran** berdasarkan waktunya (Semester 2 Tahun 2021 - Semester 1 Tahun 2023) dan dikelompokkan berdasarkan batasnya yaitu 1 untuk `(x < 0,01)`, 2 untuk `(x ≥ 0,01)`
:::
```{r warning=FALSE, cache=FALSE}
#menghilangkan nilai NA (missing value)
tbl3 <- tbl1 %>% drop_na(cemaran)
tbl3$batas_cemaran <- factor(tbl3$batas_cemaran, levels = 1:2, labels = c("x < 0,01","x ≥ 0,01"))

#Jumlah untuk tiap semester dan batas cemaran
cemaran_tbl3 <- tbl3 %>% group_by(semester, batas_cemaran) %>% summarise(n_cemaran = n(), .groups = "keep")

#Jumlah untuk tiap semester
n_semester_cemaran <- tbl3 %>% group_by(semester) %>% summarise(N = n())

#Gabungan untuk total semester
tbl_temp_cemaran <- cemaran_tbl3 %>% left_join(n_semester_cemaran, by = "semester") %>% mutate(persen = round(100*n_cemaran/N,2))
```

::: {style="text-align: justify;"}
**Tabel Perhitungan Jumlah untuk Setiap Batas dalam Semester**
:::

```{r warning=FALSE, cache=FALSE}
tbl3_output <- tbl_temp_cemaran %>% select(semester, N, batas_cemaran, n_cemaran) %>% pivot_wider(names_from = "batas_cemaran", values_from = "n_cemaran")
#tbl1_output$semester <- factor(tbl1_output$semester, levels = c("2021-02","2022-01","2022-02","2023-01"))
reactable::reactable(tbl3_output, filterable = TRUE)
```

::: {style="text-align: justify;"}
**Tabel Perhitungan Persentase untuk Setiap Batas dalam Semester**
:::

```{r warning=FALSE, cache=FALSE}
#tabel persentase
tbl3_output_persen <- tbl_temp_cemaran %>% select(semester, N, batas_cemaran, persen) %>% pivot_wider(names_from = "batas_cemaran", values_from = "persen") %>% arrange(semester)
#colnames(tbl1_output_persen)[3:5] <- c("x < 0,5","0,05 ≤ x< 0,6","x ≥ 0,6")
reactable::reactable(tbl3_output_persen, filterable = TRUE)
```

::: {style="text-align: justify;"}
Selanjutnya, pembagian terhadap **Sarana Produksi** dan **Sarana Distribusi** untuk setiap semester
:::

```{r warning=FALSE, cache=FALSE}
#Jumlah untuk tiap semester dan batas migrasi per sarana
cemaran_tbl4 <- tbl3 %>% group_by(semester, lokasi_sampling, batas_cemaran) %>% summarise(n_cemaran = n(), .groups = "keep")

#Jumlah untuk tiap semester
n_semester3 <- tbl3 %>% group_by(semester, lokasi_sampling) %>% summarise(N = n(), .groups = "keep")

#Gabungan untuk total semester
tbl_temp3 <- cemaran_tbl4 %>% left_join(n_semester3, by = c("semester","lokasi_sampling")) %>% mutate(persen = round(100*n_cemaran/N,2))
```

::: {style="text-align: justify;"}
**Tabel Perhitungan Jumlah untuk Setiap Batas dan Lokasi Sampling dalam Semester**
:::

```{r warning=FALSE, cache=FALSE}
#tabel perhitungan
tbl1_output3 <- tbl_temp3 %>% select(semester, lokasi_sampling, batas_cemaran, N, n_cemaran) %>% pivot_wider(names_from = "batas_cemaran", values_from = "n_cemaran")
#colnames(tbl1_output2)[4:6] <- c("x < 0,5","0,05 ≤ x< 0,6","x ≥ 0,6")
reactable::reactable(tbl1_output3, filterable = TRUE)
```

::: {style="text-align: justify;"}
**Persebaran Nilai Migrasi untuk setiap Semester dan Lokasi Sampling**
:::

```{r fig.width = 12, fig.height = 7, fig.fullwidth = TRUE, warning=FALSE, message=FALSE, cache=FALSE, out.width='100%'}
ggplot(tbl3, aes(lokasi_sampling, cemaran)) +
  geom_boxplot(outlier.shape = NA)+
  geom_sina(aes(colour = batas_cemaran, group = lokasi_sampling), size = 2)+
  facet_wrap(~semester, nrow = 1) +
  geom_hline(yintercept = 0.01, size = 1, linetype = "dashed", color = "red") +
  scale_colour_manual(values = c("#41b6c4","#225ea8")) +
  theme_bw()
```

::: {style="text-align: justify;"}
**Peta Persebaran Cemaran dari Lokasi Sampling Semester 2 2021 hingga Semester 1 2023** Selanjutnya, akan dilihat persebaran titik berdasarkan lokasinya dengan ditandai lokasi yang memiliki nilai migrasi ≥ 0,01
:::
```{r fig.width = 12, fig.height = 5, fig.fullwidth = TRUE, echo=TRUE, out.width='100%', warning=FALSE, cache=FALSE}
library(sf)
library(ggplot2)

# Untuk mengambil peta Indonesia
#indo <- read_xlsx("maps_indo.xlsx") #Peta indonesia
#colnames(kemasan)
spasial2 <- kemasan %>% select(semester, lokasi_sampling, balai, kab_kota, long, lat, cemaran) %>% 
  mutate(batas_cemaran = ifelse(cemaran<0.01,1,2)) %>%
  arrange(cemaran)
spasial2$batas_cemaran <- factor(spasial2$batas_cemaran, levels = 1:2, labels = c("x < 0,01","x ≥ 0,01"))

#menentukan batas untuk memunculkan yang > 0,6
idx_2 <- which(spasial2$cemaran >= 0.01)

  ggplot(data = spasial2 %>% drop_na(cemaran), aes(long, lat)) +
  geom_map(data = indo, map = indo, aes(x = long, y = lat, map_id = region),fill = "grey75") +
  geom_point(data = spasial2 %>% drop_na(`cemaran`), aes(size = cemaran, color = batas_cemaran)) +
  guides(color = guide_legend(title = "Batas Cemaran"), size = guide_legend(title = "Nilai Kadar Cemaran")) +
  geom_text(data = spasial2[idx_2,], aes(long, lat), label = spasial2$balai[idx_2], nudge_y = -0.5, check_overlap = TRUE, size = 2.5) +
  scale_color_manual(values = c('#fb6a4a','#a50f15')) +
  theme_minimal()
```

```{r warning=FALSE, cache=FALSE}
reactable::reactable(spasial2[idx_2,] %>% select(semester, lokasi_sampling, balai, cemaran), filterable = TRUE)
```